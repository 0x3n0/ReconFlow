name: Recon & Takeover

on:
  push:
    branches: [main]

jobs:
  full-recon:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Go 1.23
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Dependencies & Tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget unzip jq git curl dnsutils
          # Install Go tools
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest && sudo mv ~/go/bin/httpx /usr/bin/
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest && sudo mv ~/go/bin/subfinder /usr/bin/
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest && sudo mv ~/go/bin/dnsx /usr/bin/
          go install github.com/tomnomnom/qsreplace@latest && sudo mv ~/go/bin/qsreplace /usr/bin/
          go install github.com/lc/gau/v2/cmd/gau@latest && sudo mv ~/go/bin/gau /usr/bin/
          go install github.com/cybercdh/assetfinder@cybercdh && sudo mv ~/go/bin/assetfinder /usr/bin/
          go install github.com/PentestPad/subzy@latest && sudo mv ~/go/bin/subzy /usr/bin/
          # Install nuclei (latest release)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | jq -r '.tag_name')
          CLEAN_VERSION=${LATEST_VERSION#v}
          wget https://github.com/projectdiscovery/nuclei/releases/download/${LATEST_VERSION}/nuclei_${CLEAN_VERSION}_linux_amd64.zip
          unzip -o nuclei_${CLEAN_VERSION}_linux_amd64.zip
          sudo mv nuclei /usr/bin/
          sudo chmod +x /usr/bin/nuclei
          rm -rf nuclei* *.md

      - name: Recon
        env:
          DOMAINS: ${{ secrets.DOMAIN }}
        run: |
          set -e
          TODAY=$(date +%F)
          mkdir -p results
          echo "$DOMAINS" | while read -r TARGET; do
            echo "\nüöÄ Start: $TARGET"

            mkdir -p results/$TARGET

            echo "[*] Subdomain Enumeration..."
            assetfinder $TARGET --subs-only | grep "\.${TARGET}$" | sort -u > results/$TARGET/subdomains.txt

            echo "[*] Probing live hosts..."
            cat results/$TARGET/subdomains.txt | httpx -silent \
              -status-code -location -title -web-server -cname -ip \
              -tech-detect -cdn -method -probe -follow-redirects -fr \
              -random-agent -no-color -timeout 15 -retries 3 -threads 100 \
              -o results/$TARGET/httpx.txt
            
            echo "[*] Filtering SUCCESS responses..."
            cat results/$TARGET/httpx.txt | grep "SUCCESS" | awk '{print $1}' > results/$TARGET/httpx-success.txt

            echo "[*] Resolving DNS (via dnsx)..."
            awk '{print $1}' results/$TARGET/httpx.txt | dnsx -nc -cname -resp -silent > results/$TARGET/dnsx.txt

            echo "[*] Filtering dangling CNAME (possible takeover)..."
            awk '/\[CNAME\]/ {
              gsub(/\[|\]/, "", $0);
              print $1, $3;
            }' results/$TARGET/subdomains.txt | while read sub cname; do
              if ! dig +short "$cname" | grep -q .; then
                echo "$sub -> $cname" >> results/$TARGET/dangling.txt
              fi
            done

            echo "[*] Running Subdomain Takeover Check with Subzy (original list)..."
            subzy run --targets results/$TARGET/subdomains.txt \
              --concurrency 50 \
              --hide_fails \
              --timeout 10 \
              --vuln \
              --output results/$TARGET/subzy-subdomains.json
            git add results/$TARGET/subzy-subdomains.json
            git commit -m "[$TARGET] Subzy $(date -u)" --no-verify || true
            git push origin HEAD:main || true

            #echo "[*] Extra Subzy (from resolved list)..."
            #awk '{print $1}' results/$TARGET/dnsx.txt | sort -u > results/$TARGET/filtered.txt
            #subzy run --targets results/$TARGET/filtered.txt \
            #  --concurrency 50 \
            #  --hide_fails \
            #  --timeout 10 \
            #  --vuln \
            #  --output results/$TARGET/subzy-dnsx.json

            echo "[*] Running Nuclei on HTTPX targets..."
            nuclei -l results/$TARGET/httpx-success.txt \
              -severity low, medium, high, critical, unknown \
              -c 50 \
              -timeout 10 \
              -rate-limit 100 \
              -silent \
              -o results/$TARGET/nuclei-httpx.txt
          done

      - name: Send Alert
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DOMAINS: ${{ secrets.DOMAIN }}
        run: |
          echo "$DOMAINS" | tr -d '\r' \
            | tr ',;' '\n' \
            | tr '[:space:]' '\n' \
            | sed '/^[[:space:]]*$/d' \
            | sort -u \
            | while IFS= read -r TARGET || [ -n "$TARGET" ]; do
              TARGET=$(echo "$TARGET" | xargs)
              [ -z "$TARGET" ] && continue

              if [ -s "results/$TARGET/nuclei-httpx.txt" ]; then
                declare -A SEV_EMOJI=(
                  ["critical"]="üö® Critical"
                  ["high"]="üî¥ High"
                  ["medium"]="üü† Medium"
                  ["low"]="üü¢ Low"
                  ["unknown"]="‚ùì Unknown"
                )
                for sev in critical high medium low unknown; do
                  grep -i "\[$sev\]" "results/$TARGET/nuclei-httpx.txt" | while IFS= read -r line; do
                    curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                      -d chat_id="${TELEGRAM_CHAT_ID}" \
                      --data-urlencode "text=${SEV_EMOJI[$sev]} | $line"
                    sleep 0.5
                  done
                done
              else
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                  -d chat_id="${TELEGRAM_CHAT_ID}" \
                  -d text="‚úÖ Scan done for: $TARGET ‚Äî No vulnerabilities found."
              fi
            done

      - name: Git & Push results
        if: always()
        env:
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
          USER_NAME: ${{ secrets.USER_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global user.email "${EMAIL_ADDRESS}"
          git config --global user.name "${USER_NAME}"
          git add results/ || true
          git commit -m "[$TARGET] done $(date -u)" --no-verify || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git push origin HEAD:master || true
